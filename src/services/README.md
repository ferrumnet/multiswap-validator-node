# index.ts

The `index.ts` file within the `src/services` directory of the `ferrumnet/multiswap-validator-node` repository serves as a central point for exporting modules. This file essentially organizes and makes accessible the defined modules in the project for periodic tasks.

# axios.service.ts

The file `axios.service.ts` contains three primary functions related to HTTP operations using the `axios` library, each designed to interact with the MultiSwap backend. Below are detailed descriptions of each function:

### Function: `getTransactions`

This asynchronous function fetches a list of transactions with a specific status from the Multiswap backend API. It dynamically constructs the request URL based on the environment settings and includes authorization headers.

Parameters: None

Returns:

- `Array`: A list of transactions if successful.
- `null`: In case of an error during the HTTP request.

Details:

- Base URL: Depending on whether the environment is local, it switches between the AWS environment's BASE URL and a local URL.
- Headers: Includes an authorization token generated by `createAuthTokenForMultiswapBackend` and prefixed by a bearer token.
- URL Parameters: Status set to "generatorSignatureCreated", public key from the environment, a limit of 20, and nodeType set to "validator".
- Error Handling: Catches and logs any error that occurs during the Axios request.

### Function: `updateTransaction`

This asynchronous function sends a PUT request to update a specific transaction in the Multiswap backend. The transaction to update is identified by its hash, and it sends additional transaction data as part of the request body.

Parameters:

- `txHash` (string): The hash of the transaction to update.
- `body` (any): The new data for the transaction to be updated.

Returns:

- Axios `Promise`: Resolves with the response data from the API or rejects with an error.

Details:

- Base URL: Like the `getTransactions` function, it chooses the base URL based on the environment.
- Headers: Includes an authorization token as in the `getTransactions` function.
- URL: Includes the transaction hash and public key in the query parameters.
- Error Handling: Managed by Axios and the function's caller through promise resolution and rejection.

These functions play a critical role in interacting with the backend services, especially in handling and updating transactions in different environments.

# signature.service.ts

1.  **`getDataForSignature`**: Prepares the data required for signature creation based on the job and transaction details.

2.  **`getValidWithdrawalData`**: Validates and retrieves withdrawal data if it matches the expected hash and conditions.

3.  **`isValidSettledAmount`**: Checks if the settled amount is valid considering slippage, fees, and other parameters.

4.  **`createSignedPayment`**: Creates a signed payment transaction using different hash-producing functions based on the asset type.

5.  **`produceFoundaryHash` and `produceOneInchHash`**: Produce hashes for different types of transactions (Foundary and OneInch).

6.  **`domainSeparator`**: Creates a domain separator for EIP-712 compliant signatures.

7.  **`fixSig`**: Fixes the signature format.

8.  **`validateSignature`**: Validates if the provided signatures match the expected ones.

9.  **`isRecoverAddressValid`**: Checks if the recovered address from the signature is allowed.

10. **`getDataForSalt`**: Prepares data for generating a salt value used in hashing.

11. **`getDistributedFee`**: Retrieves the distributed fee from the transaction logs.

# transaction.service.ts

The file `transaction.service.ts` in the repository contains several key functions related to transaction handling for the multiswap validator node. Below is a detailed description of each function within this file:

### 1\. `fetchChainDataFromNetwork(tx: any)`

This function fetches chain data from the network based on the transaction details provided. It assembles a job request body containing details about the transaction, including RPC URLs, asset types, transaction IDs, and more. Depending on whether the source network is EVM or non-EVM, it either retrieves transaction receipts directly via web3 services or potentially through other services (commented out in the code, indicating possible non-EVM handling).

#### Parameters:

- `tx`: The transaction object containing various details about the transaction.

#### Actions:

- Assembles data for a job.
- Fetches the transaction receipt.
- Calls `verifyAndCreateSignature` if the transaction receipt indicates success.

### 2\. `verifyAndCreateSignature(job: any)`

Attempts to verify and create a signature for the job. It decodes transaction details and, depending on whether the destination is EVM or non-EVM, processes signatures and possibly updates the transaction.

#### Parameters:

- `job`: An object containing job data and transaction details.

#### Actions:

- Decodes transaction data.
- Verifies signatures and updates the transaction accordingly.
- Handles errors and logs them.

### 3\. `updateTransaction(job: any, signedData: any, tx: any)`

Updates the transaction details on an external service using `axiosService` based on the job data and signed data received.

#### Parameters:

- `job`: The job object containing data about the transaction.
- `signedData`: The signed data of the transaction.
- `tx`: The transaction details.

#### Actions:

- Sends an update request for the transaction.
- Removes the transaction hash from the local list upon successful update.
- Handles errors and logs them.

### 4\. `getGeneratorHash(tx: any): string`

Generates a hash from the transaction's generator signature.

#### Parameters:

- `tx`: The transaction object.

#### Actions:

- Extracts the first signature hash if available.
- Returns the hash or an empty string if none found.

Each of these functions plays a crucial role in processing and managing transactions within the multiswap validator node, handling everything from data fetching, signature verification, and transaction updating.

# web3.service.ts

1.  **getTransactionReceipt**

        - **Description**: Retrieves the transaction receipt for a given transaction ID (`txId`) and chain ID (`chainId`). It attempts to get the receipt up to a specified `threshold` number of tries.
        - **Parameters**:
          - `txId`: Transaction ID.
          - `chainId`: Chain ID.
          - `threshold`: Maximum number of attempts.
          - `tries`: Current number of attempts.
        - **Returns**: A promise that resolves to a `TransactionReceipt`.

2.  **getTransactionByHash**

        - **Description**: Fetches the transaction details using the transaction hash (`txHash`) and chain ID (`chainId`).
        - **Parameters**:
          - `txHash`: Transaction hash.
          - `chainId`: Chain ID.
        - **Returns**: A promise that resolves to a `Transaction`.

3.  **signedTransaction**

        - **Description**: Signs a transaction using the provided job data, decoded data, and transaction details. It also checks if the transaction is for validation.
        - **Parameters**:
          - `job`: Job data.
          - `decodedData`: Decoded data from the transaction.
          - `transaction`: Transaction data.
          - `isForValidation`: Boolean indicating if the transaction is for validation.
        - **Returns**: A promise that resolves to an object containing transaction data and signatures.

4.  **getLogsFromTransactionReceipt**

    - **Description**: Extracts logs from a transaction receipt based on the job data and whether it is for distributed fees.
    - **Parameters**:
      - `job`: Job data.
      - `isDistributedFee`: Boolean indicating if it is for distributed fees.
    - **Returns**: Decoded log data.

5.  **getFundManagerAddress**

    - **Description**: Retrieves the fund manager address for a specific chain ID and whether it is for CCTP.
    - **Parameters**:
      - `chainId`: Chain ID.
      - `isCCTP`: Boolean indicating if it is for CCTP.
    - **Returns**: Fund manager address.

6.  **getFiberRouterAddress**

    - **Description**: Retrieves the Fiber Router address for a specific chain ID.
    - **Parameters**:
      - `chainId`: Chain ID.
    - **Returns**: Fiber Router address.

7.  **getFoundaryTokenAddress**

    - **Description**: Retrieves the Foundary Token address for a specific chain ID.
    - **Parameters**:
      - `chainId`: Chain ID.
    - **Returns**: Foundary Token address.

8.  **getAggregateRouterTokenAddress**

    - **Description**: Retrieves the Aggregate Router Token address for a specific chain ID.
    - **Parameters**:
      - `chainId`: Chain ID.
    - **Returns**: Aggregate Router Token address.

9.  **checkValidTransactionAndReturnReceipt**

        - **Description**: Validates a transaction and returns its receipt.
        - **Parameters**:
          - `txId`: Transaction ID.
          - `chainId`: Chain ID.
          - `receipt`: Transaction receipt.
        - **Returns**: A promise that resolves to the transaction receipt if valid, otherwise null.

10. **delay**

    - **Description**: Utility function to create a delay of 30 seconds.
    - **Returns**: A promise that resolves after 30 seconds.
